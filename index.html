<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OSM Priority Map (Simplified)</title>
<style>
  body { font-family: sans-serif; margin: 0; padding: 0; }
  #map { height: 70vh; }
  #controls { padding: 1rem; background: #f4f4f4; }
  textarea { width: 100%; height: 200px; }
  table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  th, td { border: 1px solid #ccc; padding: 4px; }
  th { background: #eee; }
  .Low { color: green; font-weight: bold; }
  .Medium { color: orange; font-weight: bold; }
  .High { color: red; font-weight: bold; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">// LOAD FILE
function loadFileGeoJSON(evt){
  const file = document.getElementById('fileInput').files[0];
  if(!file) return alert('No file selected');
  const reader = new FileReader();
  reader.onload = function(e){
    document.getElementById('geojsonInput').value = e.target.result;
    alert('GeoJSON loaded into text area');
  };
  reader.readAsText(file);
}
document.getElementById('loadBtn').onclick = loadFileGeoJSON;
// --- FIXED LOAD FUNCTION ---
function loadFileGeoJSON() {
  const input = document.getElementById('fileInput');
  if (!input || !input.files || !input.files[0]) {
    alert('Please select a GeoJSON file first.');
    return;
  }
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('geojsonInput').value = e.target.result;
    alert('GeoJSON loaded! Now click Process GeoJSON.');
  };
  reader.readAsText(file);
}

document.getElementById('loadBtn').onclick = loadFileGeoJSON;
</script>
</head>
<body>
<div id="controls">
  <h2>OSM Priority Map â€“ Simplified Low/Medium/High System</h2>
  <p>Paste your GeoJSON below (must contain <b>unmapped_building_percent</b> and <b>population_density</b> per feature).</p>

  <textarea id="geojsonInput" placeholder="Paste GeoJSON here..."></textarea>

  <button id="processBtn">Process GeoJSON</button>
  <input type="file" id="fileInput" accept="application/geo+json,application/json,.geojson" />
  <button id="loadBtn">Load GeoJSON</button>
  <button id="downloadBtn">Download Processed GeoJSON</button>

  <h3>Top Priority Areas</h3>
  <table id="resultTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Unmapped %</th>
        <th>Pop Density</th>
        <th>Priority</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="map"></div>

<script>
let map = L.map('map').setView([0, 120], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let geoLayer;

// --------------------------------------------------
// SIMPLE PRIORITY SYSTEM: Low / Medium / High
// --------------------------------------------------
function computePriority(props) {
  const unmapped = props.unmapped_building_percent ?? 0;
  const density = props.population_density ?? 0;

  const score = (unmapped * 0.6) + (density * 0.4);

  let priority = "Low";
  if (score >= 60) priority = "High";
  else if (score >= 30) priority = "Medium";

  props.priority = priority;
  props.priority_score = score;
}

function getColor(priority) {
  if (priority === "High") return "#ff0000";
  if (priority === "Medium") return "#ffa500";
  return "#00aa00";
}

// --------------------------------------------------
// PROCESSING
// --------------------------------------------------
function processGeoJSON() {
  const inputText = document.getElementById("geojsonInput").value.trim();
  if (!inputText) return alert("GeoJSON is empty");

  let data;
  try { data = JSON.parse(inputText); }
  catch (e) { return alert("Invalid JSON"); }

  if (!data.features) return alert("No features found");

  data.features.forEach(f => {
    computePriority(f.properties);
  });

  renderMap(data);
  renderTable(data.features);

  window.processedData = data; // store for download

  alert("Processing done");
}

// --------------------------------------------------
// MAP RENDER
// --------------------------------------------------
function renderMap(data) {
  if (geoLayer) geoLayer.remove();

  geoLayer = L.geoJSON(data, {
    style: f => ({
      color: getColor(f.properties.priority),
      weight: 2,
      fillOpacity: 0.2
    }),
    onEachFeature: (f, layer) => {
      const p = f.properties;
      layer.bindPopup(
        `<b>${p.name ?? "Unnamed area"}</b><br>
         Unmapped: ${p.unmapped_building_percent ?? 0}%<br>
         Pop Density: ${p.population_density ?? 0}<br>
         Priority: <b class="${p.priority}">${p.priority}</b>`
      );
    }
  }).addTo(map);

  map.fitBounds(geoLayer.getBounds());
}

// --------------------------------------------------
// TABLE RENDER
// --------------------------------------------------
function renderTable(features) {
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = "";

  const sorted = [...features].sort((a, b) => b.properties.priority_score - a.properties.priority_score);

  sorted.forEach(f => {
    const p = f.properties;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name ?? "Unnamed"}</td>
      <td>${p.unmapped_building_percent ?? 0}</td>
      <td>${p.population_density ?? 0}</td>
      <td class="${p.priority}">${p.priority}</td>
    `;
    tbody.appendChild(tr);
  });
}

// --------------------------------------------------
// DOWNLOAD
// --------------------------------------------------
function downloadProcessed() {
  if (!window.processedData) return alert("Process data first");

  const blob = new Blob([JSON.stringify(window.processedData)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "processed_priority.geojson";
  a.click();
  URL.revokeObjectURL(url);
}

document.getElementById("processBtn").onclick = processGeoJSON;
document.getElementById("downloadBtn").onclick = downloadProcessed;
</script>
</body>
</html>
